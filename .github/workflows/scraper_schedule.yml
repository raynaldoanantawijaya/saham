name: Daily Scraper (Docker)

on:
  schedule:
    # 1. Stocks: Mon-Fri 09:05 WIB = 02:05 UTC & 16:05 WIB = 09:05 UTC
    - cron: '5 2,9 * * 1-5'
    
    # 2. Gold/Crypto: Daily 08:00 WIB = 01:00 UTC, 14:00 WIB = 07:00 UTC, 20:00 WIB = 13:00 UTC
    - cron: '0 1,7,13 * * *'

  workflow_dispatch:

jobs:
  scrape-data:
    runs-on: ubuntu-latest
    # VITAL: Run inside the official Puppeteer container
    container:
      image: ghcr.io/puppeteer/puppeteer:latest
      options: --user root # Run as root to allow installing extra npm packages if needed

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Note: Node & Chrome are PRE-INSTALLED in this image! 
      # We just need to install our project dependencies.
      
      - name: Install Project Dependencies
        # Use 'npm install' but skip puppeteer download (it's already in the image)
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable
        run: |
          npm install

      - name: Run Scraper
        env:
          # Tell our script where Chrome is
          PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable
        run: |
          # Same logic as before
          HOUR=$(date -u +%H)
          TARGET="gold_crypto"
          
          if [ "$HOUR" -eq "02" ] || [ "$HOUR" -eq "09" ]; then
             TARGET="stocks"
             echo "Target: STOCKS"
             node gh_scraper.js --target=stocks
          else
             echo "Target: GOLD/CRYPTO"
             node gh_scraper.js --target=gold_crypto
          fi
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Manual Trigger: ALL"
             node gh_scraper.js --target=all
          fi

      # COMMIT (Need to install git in the container first because it's minimal)
      - name: Commit and Push
        run: |
          apt-get update && apt-get install -y git
          git config --global --add safe.directory /__w/saham/saham
          git config --global user.name "GitHub Action Scraper"
          git config --global user.email "actions@github.com"
          
          git add idx_data.json gold_data.json crypto_data.json all_data.json
          
          # Only commit if data changed
          git diff --quiet && git diff --staged --quiet || (git commit -m "data: auto-update prices [skip ci]" && git push)
