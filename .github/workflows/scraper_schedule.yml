name: Daily Scraper (Stocks & Crypto)

on:
  schedule:
    # 1. Stocks: Mon-Fri 09:05 WIB = 02:05 UTC & 16:05 WIB = 09:05 UTC
    - cron: '5 2,9 * * 1-5'
    
    # 2. Gold/Crypto: Daily 08:00 WIB = 01:00 UTC, 14:0 WIB = 07:00 UTC, 20:00 WIB = 13:00 UTC
    - cron: '0 1,7,13 * * *'

  workflow_dispatch: # Allow manual trigger button

jobs:
  scrape-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 1. SETUP CHROME (Official Action)
      - name: Setup Chrome
        uses: browser-actions/setup-chrome@v1
        id: setup-chrome
        with:
          chrome-version: stable

      # 2. SETUP NODE
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. INSTALL DEPS (Skip Chromium Download)
      - name: Install Dependencies
        run: npm install
        env:
          PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: "true"

      # 4. RUN SCRAPER
      - name: Determine Target & Run Scraper
        env:
          # IMPORTANT: Point Puppeteer to the installed Chrome
          PUPPETEER_EXECUTABLE_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
          # Also set for script usage if needed
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
        run: |
          # Get current hour in UTC
          HOUR=$(date -u +%H)
          
          # Default to gold_crypto
          TARGET="gold_crypto"
          
          # If UTC hour is roughly 02 (09 WIB) or 09 (16 WIB), run stocks too
          if [ "$HOUR" -eq "02" ] || [ "$HOUR" -eq "09" ]; then
             TARGET="stocks"
             echo "Time matches Stocks Schedule. Running for STOCKS."
             node gh_scraper.js --target=stocks
          else
             echo "Time matches Gold/Crypto Schedule. Running for GOLD/CRYPTO."
             node gh_scraper.js --target=gold_crypto
          fi
          
          # Force run ALL if triggered manually
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Manual Trigger detected. Running ALL."
             node gh_scraper.js --target=all
          fi

      # 5. COMMIT RESULTS
      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Action Scraper"
          git config --global user.email "actions@github.com"
          git add idx_data.json gold_data.json crypto_data.json all_data.json
          
          # Only commit if data changed
          git diff --quiet && git diff --staged --quiet || (git commit -m "data: auto-update prices [skip ci]" && git push)
