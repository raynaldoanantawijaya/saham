name: Daily Scraper (Stocks & Crypto)

on:
  schedule:
    # 1. Stocks: Mon-Fri 09:05 WIB = 02:05 UTC & 16:05 WIB = 09:05 UTC
    - cron: '5 2,9 * * 1-5'
    
    # 2. Gold/Crypto: Daily 08:00 WIB = 01:00 UTC, 14:0 WIB = 07:00 UTC, 20:00 WIB = 13:00 UTC
    - cron: '0 1,7,13 * * *'

  workflow_dispatch: # Allow manual trigger button

jobs:
  scrape-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install

      - name: Determine Target & Run Scraper
        run: |
          # Get current hour in UTC
          HOUR=$(date -u +%H)
          
          # Default to gold_crypto (safe choice)
          TARGET="gold_crypto"
          
          # If UTC hour is roughly 02 (09 WIB) or 09 (16 WIB), run stocks too
          if [ "$HOUR" -eq "02" ] || [ "$HOUR" -eq "09" ]; then
             TARGET="stocks"
             echo "Time matches Stocks Schedule. Running for STOCKS."
             node gh_scraper.js --target=stocks
          else
             echo "Time matches Gold/Crypto Schedule. Running for GOLD/CRYPTO."
             node gh_scraper.js --target=gold_crypto
          fi
          
          # Note: If triggered manually via button, run everything
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
             echo "Manual Trigger detected. Running ALL."
             node gh_scraper.js --target=all
          fi

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Action Scraper"
          git config --global user.email "actions@github.com"
          git add idx_data.json gold_data.json crypto_data.json
          
          # Only commit if data changed
          git diff --quiet && git diff --staged --quiet || (git commit -m "data: auto-update prices [skip ci]" && git push)
